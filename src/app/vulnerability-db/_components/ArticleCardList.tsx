'use client';

import SuggestionChip from '@/components/Chips/SuggestionChip';
import ArticleCard from '@/components/VulDbCard/ArticleCard';
import { ApiResponse, ArticleData } from '@/types/crawlingData';
import { useSession } from 'next-auth/react';
import Link from 'next/link';
import { usePathname, useRouter, useSearchParams } from 'next/navigation';

export default function ArticleCardList({ data }: ApiResponse<ArticleData[]>) {
  const searchParams = useSearchParams();
  const nowLabel = searchParams.get('label');
  const pathname = usePathname();
  const router = useRouter();
  const session = useSession();
  const userId = session.data?.user.id;

  const onClickLabel = (label: string) => {
    const params = new URLSearchParams(searchParams);
    params.set('label', label);
    params.set('page', '1');
    router.replace(`${pathname}?${params.toString()}`, { scroll: false });
  };

  const onClickArticle = async (id: string) => {
    try {
      await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/vulDb`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id }),
      });
    } catch (error) {
      throw new Error('검색어 저장 실패');
    }
  };

  if (!userId) {
    return (
      <div className="flex h-[141.4rem] w-[86.5rem] flex-col gap-[1.6rem] bg-[url(/images/blurDb.png)]">
        <div className="m-[4.3rem_auto_0] flex w-fit flex-col items-center gap-[3.2rem] rounded-[2rem] bg-white px-[6rem] py-[4rem] shadow-drop">
          <span className="text-[2rem]">자세한 정보를 보고싶다면?</span>
          <Link href="/login">
            <h2 className="w-fit cursor-pointer rounded-full border-[0.2rem] border-primary-500 bg-white px-[4rem] py-[2rem] text-[2.4rem] font-regular text-primary-500">
              Login
            </h2>
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-[1.6rem]">
      <h2 className="text-[2.4rem] font-bold leading-[2.905rem]">취약점 DB</h2>
      <div className="flex gap-[1.2rem]">
        <button type="button" onClick={() => onClickLabel('hot')}>
          <SuggestionChip variant="hot" isActive={nowLabel === 'hot'} />
        </button>
        <button type="button" onClick={() => onClickLabel('new')}>
          <SuggestionChip variant="new" isActive={nowLabel === 'new'} />
        </button>
      </div>
      <div className="flex flex-col gap-[1.6rem]">
        {data?.map(dataItem => (
          <Link
            key={dataItem.id}
            href={`/vulnerability-db/${dataItem.id}`}
            onClick={() => onClickArticle(dataItem.id)}
          >
            <ArticleCard
              company={dataItem.company}
              date={dataItem.scrapDate}
              labelList={dataItem.labelList}
              id={dataItem.id}
              title={dataItem.title}
              content={
                typeof dataItem.content[0] === 'string' ? dataItem.content[0] : 'table 데이터....'
              }
              keyword={dataItem.keyword}
              isScrapped={dataItem.isScrapped}
            />
          </Link>
        ))}
      </div>
    </div>
  );
}
